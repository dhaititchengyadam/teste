<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final</title>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 800px; margin: auto; padding: 20px; background: #f0f2f5; color: #333; }
        h1 { text-align: center; color: #f38020; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .license-card { background: #fff3cd; border-left: 6px solid #f38020; }
        h3 { margin-top: 0; color: #f38020; }
        button { background: #f38020; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 8px 4px; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        button.stop { background: #d32f2f; }
        button.upload { background: #1976d2; }
        button.agree { background: #28a745; font-size: 1.1em; }
        button.speak { background: #6c757d; }
        pre { background: #1e1e1e; color: #0f0; padding: 16px; border-radius: 8px; overflow-x: auto; min-height: 80px; margin-top: 16px; white-space: pre-wrap; }
        .record-controls { margin: 16px 0; }
        #timer { font-size: 1.5em; font-weight: bold; color: #f38020; }
        #recordStatus { margin: 8px 0; }
        audio { margin-top: 10px; width: 100%; }
        .or { text-align: center; margin: 20px 0; font-weight: bold; color: #666; }
        #licenseStatus { margin: 16px 0; font-weight: bold; }
        textarea { width: 100%; height: 100px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>üî• AI Dashboard</h1>

    <div class="card license-card">
        <h3>‚ö†Ô∏è Image Analysis Setup</h3>
        <p>First time only: accept Meta license.</p>
        <button id="agreeBtn" class="agree">üü¢ Accept Meta License</button>
        <p id="licenseStatus">Status: Not accepted yet ‚Äì click button.</p>
    </div>

    <div class="card">
        <h3>üì∑ Image Analysis (excellent face detection)</h3>
        <input type="file" id="imgInput" accept="image/*">
        <button id="btnImg">Analyze Image</button>
        <pre id="resImg">Waiting for result...</pre>
        <button class="speak" onclick="speakResult('resImg')">üîä Read Aloud (English)</button>
    </div>

    <div class="card">
        <h3>üéôÔ∏è Speech to Text</h3>
        <div class="record-controls">
            <p id="recordStatus">Ready to record...</p>
            <p id="timer">00:00</p>
            <button id="startBtn">üü¢ Start</button>
            <button id="stopBtn" class="stop" disabled>üî¥ Stop</button>
            <audio id="previewAudio" controls style="display:none;"></audio>
        </div>
        <div class="or">‚Äî‚Äî OR ‚Äî‚Äî</div>
        <input type="file" id="audioFile" accept="audio/*,video/*">
        <button id="uploadBtn" class="upload">Upload File</button>
        <pre id="resAudio">Waiting for result...</pre>
        <button class="speak" onclick="speakResult('resAudio')">üîä Read Transcription (English)</button>
    </div>

    <div class="card">
        <h3>üîä Text to Speech (English only - reliable)</h3>
        <textarea id="ttsText" placeholder="Write text to hear aloud (English pronunciation)..."></textarea>
        <button id="ttsBtn">Generate Audio</button>
        <audio id="ttsAudio" controls></audio>
    </div>

    <script>
        const BASE_URL = "https://teste.adamdh7.org";

        document.getElementById('agreeBtn').onclick = async () => {
            const status = document.getElementById('licenseStatus');
            const btn = document.getElementById('agreeBtn');
            btn.disabled = true;
            status.innerText = "Sending...";
            try {
                const response = await fetch(`${BASE_URL}/agree-llama`, { method: 'POST' });
                const data = await response.text();
                status.innerText = "‚úÖ Success! " + data;
                status.style.color = "green";
            } catch (err) {
                status.innerText = "‚ùå Error: " + err.message;
                btn.disabled = false;
            }
        };

        let mediaRecorder, audioChunks = [], timerInterval, seconds = 0, recordedBlob = null;

        function formatTime(sec) {
            const m = String(Math.floor(sec / 60)).padStart(2, '0');
            const s = String(sec % 60).padStart(2, '0');
            return `${m}:${s}`;
        }

        function getSupportedMimeType() {
            const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/mp4', 'audio/ogg', 'audio/wav'];
            for (const type of types) if (MediaRecorder.isTypeSupported(type)) return type;
            return '';
        }

        document.getElementById('startBtn').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];
                const mimeType = getSupportedMimeType();
                mediaRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const finalMime = mediaRecorder.mimeType || mimeType || 'audio/webm';
                    recordedBlob = new Blob(audioChunks, { type: finalMime });
                    document.getElementById('previewAudio').src = URL.createObjectURL(recordedBlob);
                    document.getElementById('previewAudio').style.display = 'block';
                    processAudio(recordedBlob, 'resAudio');
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordStatus').innerText = "Recording... Speak clearly!";

                seconds = 0;
                document.getElementById('timer').innerText = "00:00";
                timerInterval = setInterval(() => {
                    seconds++;
                    document.getElementById('timer').innerText = formatTime(seconds);
                }, 1000);
            } catch (err) {
                alert("Mic error: " + err.message);
            }
        };

        document.getElementById('stopBtn').onclick = () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(timerInterval);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('recordStatus').innerText = "Done ‚Äì processing...";
            }
        };

        document.getElementById('uploadBtn').onclick = () => {
            const file = document.getElementById('audioFile').files[0];
            if (!file) return alert("Select file first!");
            processAudio(file, 'resAudio');
        };

        document.getElementById('btnImg').onclick = () => {
            const file = document.getElementById('imgInput').files[0];
            if (!file) return alert("Select image first!");
            processImage(file);
        };

        document.getElementById('ttsBtn').onclick = () => {
            const text = document.getElementById('ttsText').value.trim();
            if (!text) return alert("Write text first!");
            processTTS(text);
        };

        async function processAudio(blobOrFile, resId) {
            const resBox = document.getElementById(resId);
            resBox.innerText = "Processing audio...";
            try {
                const response = await fetch(`${BASE_URL}/audio-to-text`, { method: 'POST', body: blobOrFile });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Server error");
                resBox.innerText = data.text || JSON.stringify(data, null, 2);
            } catch (err) {
                resBox.innerText = "Error: " + err.message;
            }
        }

        async function processImage(file) {
            const resBox = document.getElementById('resImg');
            resBox.innerText = "Analyzing image...";
            try {
                const response = await fetch(`${BASE_URL}/analize-imaj`, { method: 'POST', body: file });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || "Server error");
                resBox.innerText = data.response || JSON.stringify(data, null, 2);
            } catch (err) {
                resBox.innerText = "Error: " + err.message;
            }
        }

        async function processTTS(text) {
            const audioPlayer = document.getElementById('ttsAudio');
            try {
                const response = await fetch(`${BASE_URL}/text-to-speech`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || "Server error");
                }
                const blob = await response.blob();
                audioPlayer.src = URL.createObjectURL(blob);
                audioPlayer.play();
            } catch (err) {
                alert("Voice error: " + err.message);
            }
        }

        function speakResult(resId) {
            const text = document.getElementById(resId).innerText.trim();
            if (!text || text.includes("Waiting") || text.includes("Error")) return alert("No valid result to read!");
            processTTS(text);
        }
    </script>
</body>
</html>
