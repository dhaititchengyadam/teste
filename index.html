<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>Adam_D'H7</title>
    <link rel="manifest" href="/manifest.json?v=17">
    <link rel="canonical" href="https://ai.adamdh7.org/">
    <meta name="theme-color" content="#000000">
    <meta name="google-site-verification" content="UItG8vIV9YM3napElbB9ZAf7QYCniXwYvImdM78xTKY" />
    <meta name="description" content="Adam_D’H7, asistan entèlijan ki pale Kreyòl, Français, English ak Español. Chat, imaj, kod, tout bagay nan yon sèl kote.">
    <meta name="robots" content="index, follow">
    <link rel="apple-touch-icon" href="https://adamdh7ai.pages.dev/asset/512.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg: #000000;
            --panel: #000000;
            --ai-bubble: #262626;
            --ai-text: #d0d0d0;
            --user-blue: #0b3d91;
            --user-text: #e8f4ff;
            --muted: #7d7d7d;
            --header-h: 60px;
            --msg-gap: 14px;
            --max-msg-w: 78%;
            --wa-code-bg: rgba(255,255,255,0.03);
            --wa-inline-bg: rgba(255,255,255,0.06);
            --input-bg: #1c1c1e;
            --border: rgba(255,255,255,0.08);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body {
            background: var(--bg);
            color: var(--ai-text);
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            touch-action: pan-y;
        }

        .modern-input {
            background: #1c1c1e;
            border: none;
            border-radius: 14px;
            padding: 18px;
            color: white;
            width: 100%;
            outline: none;
            font-size: 16px;
        }

        #scr-chat {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        #scr-chat.visible { display: flex; }

        header {
            height: var(--header-h);
            background: var(--panel);
            border-bottom: 1px solid rgba(255,255,255,0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }
        #menuBtn svg { width: 28px; height: 28px; stroke: white; stroke-width: 2; }
        .title { font-weight: 800; font-size: 19px; color: white; letter-spacing: -0.5px; cursor: pointer; }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px 10px;
            display: flex;
            flex-direction: column;
            gap: var(--msg-gap);
            -webkit-overflow-scrolling: touch;
        }
        .chat-box::-webkit-scrollbar { display: none; }

        .message { 
            max-width: var(--max-msg-w); 
            align-self: flex-start; 
            opacity: 0; 
            animation: fadeIn .35s forwards; 
            word-break: break-word;
            white-space: pre-wrap;
        }
        .message.user { align-self: flex-end; }
        .bubble {
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15.8px;
            line-height: 1.42;
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
        }
        .bubble.user { background: var(--user-blue); color: var(--user-text); }
        .bubble.bot { background: var(--ai-bubble); color: var(--ai-text); border: 1px solid var(--border); }

        .meta { font-size: 11px; color: var(--muted); margin-top: 6px; text-align: right; }

        .message-media {
            margin-top: 12px;
            border-radius: 14px;
            overflow: hidden;
            position: relative;
            max-width: 320px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
        }
        .message-media img, .message-media video {
            width: 100%;
            display: block;
            border-radius: 14px;
            cursor: pointer;
        }
        .message-media audio {
            width: 100%;
            background: #111;
            padding: 8px;
        }

        @media (max-width: 920px) {
            .message-media { max-width: 90vw; }
            .message { max-width: 90%; }
        }
        @media (max-width: 520px) {
            :root { --max-msg-w: 86%; }
            .title { font-size: 16px; }
        }

        .wa-paragraph { margin: 7px 0; }
        .wa-strong { font-weight: 700; display: inline; }
        .wa-underline { text-decoration: underline; display: inline; }
        .wa-inline {
            background: var(--wa-inline-bg);
            padding: 4px 10px;
            border-radius: 8px;
            font-family: ui-monospace, Menlo, monospace;
            font-size: 14px;
            border: 1px solid var(--border);
            display: inline-block;
        }
        .wa-code-block {
            display: block;
            background: var(--wa-code-bg);
            padding: 14px;
            border-radius: 12px;
            font-family: ui-monospace, Menlo, monospace;
            font-size: 13.8px;
            line-height: 1.5;
            margin: 12px 0;
            border: 1px solid var(--border);
            white-space: pre-wrap;
            -webkit-user-select: text;
            user-select: text;
            cursor: pointer;
        }

        .copied-flash { position: relative; display: inline-block; }
        .copied-flash::after {
            content: '✔';
            position: absolute;
            right: -22px;
            top: 0;
            font-size: 14px;
            opacity: 0;
            transform: translateX(0);
            transition: .25s;
            color: #7CFC00;
        }
        .copied-flash.copied::after { opacity: 1; transform: translateX(6px); }

        .bottom-zone {
            padding: 12px 16px calc(20px + var(--safe-bottom));
            background: var(--bg);
            border-top: 1px solid rgba(255,255,255,0.04);
        }
        #errorMsg {
            text-align: center;
            padding: 12px;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border-radius: 12px;
            margin: 0 16px 12px;
            opacity: 0;
            transition: opacity 0.4s;
            pointer-events: none;
        }
        #errorMsg.show { opacity: 1; }

        .input-wrapper {
            display: flex;
            align-items: end;
            gap: 12px;
        }
        textarea {
            flex: 1;
            min-height: 56px;
            max-height: 180px;
            padding: 16px;
            border-radius: 14px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: white;
            font-size: 16px;
            resize: none;
            outline: none;
            overflow-y: auto;
        }
        textarea::placeholder {
            color: rgba(255,255,255,0.35);
        }
        .action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(180deg, var(--user-blue), #06306a);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(11,61,145,0.3);
            flex-shrink: 0;
        }
        .action-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }
        .action-btn svg {
            width: 26px;
            height: 26px;
            fill: white;
        }

        #previewContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
            padding: 0 4px;
        }
        .preview-item {
            position: relative;
            max-width: 280px;
        }
        .preview-item img, .preview-item video, .preview-item audio {
            width: 100%;
            max-height: 280px;
            object-fit: cover;
            border-radius: 14px;
            display: block;
            cursor: pointer;
        }
        .preview-item audio {
            background: #111;
            padding: 8px;
        }
        .preview-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        #modal {
            position: fixed;
            inset: 0;
            background: #000;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        #modal.active { display: flex; }
        #modalContent {
            max-width: 94vw;
            max-height: 94vh;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }
        #modalContent img, #modalContent video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #modalContent audio {
            width: 100%;
        }
        .modal-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 12px;
            z-index: 110;
        }
        #closeModalBtn, #downloadBtn {
            background: rgba(30,30,30,0.8);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
        }
        #closeModalBtn { font-size: 28px; padding: 8px 12px; }

        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body>

    <section id="scr-auth" class="flex-1 flex flex-col items-center justify-center p-8">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-7xl font-black tracking-tighter mb-2 italic cursor-pointer" onclick="showLang()">D'H7</h1>
            <p class="text-zinc-600 text-xs uppercase tracking-[0.6em] mb-16" data-key="subtitle">Digital HUB 7</p>

            <div id="login-form" class="space-y-4">
                <input type="text" id="login-id" data-key="placeholder-tfid" placeholder="TFID oswa DH7" class="modern-input">
                <input type="password" id="login-pass" data-key="placeholder-password" placeholder="Modpas" class="modern-input">
                <button onclick="login()" class="w-full bg-white text-black font-black py-4 rounded-2xl mt-6 text-lg" data-key="connect">KONEKTE</button>
                <button onclick="toggleAuth()" class="w-full text-zinc-500 text-sm mt-4" data-key="register">KREYE YON KONT</button>
            </div>

            <div id="reg-form" class="hidden space-y-4">
                <div class="flex gap-3">
                    <input type="text" id="reg-nom" data-key="placeholder-lastname" placeholder="Nom" class="modern-input">
                    <input type="text" id="reg-prenom" data-key="placeholder-firstname" placeholder="Prenom" class="modern-input">
                </div>
                <input type="text" id="reg-dh7" data-key="placeholder-dh7" placeholder="DH7 ID (@dh7.tf)" class="modern-input">
                <input type="number" id="reg-age" data-key="placeholder-age" placeholder="Laj" class="modern-input">
                <input type="password" id="reg-pass" data-key="placeholder-password" placeholder="Modpas" class="modern-input">
                <button onclick="register()" class="w-full bg-white text-black font-black py-4 rounded-2xl mt-6" data-key="create-account">JOIN D'H7</button>
                <button onclick="toggleAuth()" class="w-full text-zinc-500 text-sm mt-4" data-key="back-to-login">RETOUNEN</button>
            </div>
        </div>
    </section>

    <section id="scr-chat">
        <header>
            <button id="menuBtn" aria-label="Menu">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="title" onclick="showLang()">Adam_D'H7</div>
            <div style="width:48px"></div>
        </header>

        <main id="chatBox" class="chat-box" aria-live="polite"></main>

        <div class="bottom-zone">
            <div id="errorMsg"></div>
            <div id="previewContainer"></div>
            <form id="chatForm" autocomplete="off" novalidate>
                <div class="input-wrapper">
                    <button id="attachBtn" type="button" class="action-btn">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="white"/>
                        </svg>
                    </button>
                    <textarea id="userInput" aria-label="Mesaj" placeholder="Ekris mesaj ou..."></textarea>
                    <button id="actionBtn" class="action-btn" type="button" disabled>
                        <svg id="sendIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" fill="white"/>
                        </svg>
                        <svg id="voiceIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none;">
                            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.47,17.5 13,17.96V21H11V17.96C7.53,17.5 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" fill="white"/>
                        </svg>
                        <svg id="stopIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none;">
                            <rect x="6" y="6" width="12" height="12" fill="white"/>
                        </svg>
                    </button>
                </div>
            </form>
            <input type="file" id="fileInput" accept="image/*,video/*,audio/*" style="display:none;">
        </div>
    </section>

    <div id="userMenu">
        <div class="p-6 pt-8">
            <div id="user-name" class="text-2xl font-black text-white mb-6"></div>
            <div class="space-y-3 text-sm text-zinc-400">
                <p>TFID: <span id="user-tfid" class="font-mono text-white"></span></p>
                <div id="user-dh7-line" class="hidden">
                    <p>DH7: <span id="user-dh7" class="font-mono text-white"></span></p>
                </div>
            </div>
            <button onclick="logout()" class="mt-12 w-full bg-red-900/80 text-white py-4 rounded-2xl font-bold text-lg" data-key="logout-btn">DEKONEKTE</button>
        </div>
    </div>
    <div id="menuBackdrop" class="backdrop" onclick="closeMenu()"></div>

    <div id="backdrop" class="backdrop" onclick="closeOverlays()"></div>
    <div id="lang-sheet">
        <div class="px-6 py-4 text-center text-white text-lg cursor-pointer" onclick="changeLanguage('ht')">Kreyòl Ayisyen</div>
        <div class="px-6 py-4 text-center text-white text-lg cursor-pointer" onclick="changeLanguage('fr')">Français</div>
        <div class="px-6 py-4 text-center text-white text-lg cursor-pointer" onclick="changeLanguage('en')">English</div>
        <div class="px-6 py-4 text-center text-white text-lg cursor-pointer" onclick="changeLanguage('es')">Español</div>
        <div class="px-6 py-4 text-center text-blue-500 font-bold text-lg cursor-pointer" onclick="closeOverlays()">Fèmen</div>
    </div>

    <div id="modal">
        <div class="modal-controls">
            <button id="downloadBtn">Télécharge</button>
            <button id="closeModalBtn">✖</button>
        </div>
        <div id="modalContent"></div>
    </div>

    <script>
        const API_AUTH = "https://server.dh7.adamdh7.org";
        const API_WORKER = "https://server.ai.adamdh7.org/";
        const SESSION_KEY = 'dh7_session';

        let currentUser = null;
        let currentTfid = null;
        let currentLanguage = localStorage.getItem('language') || 'ht';

        const translations = {
            ht: { 
                subtitle: "Digital HUB 7", 
                "placeholder-tfid": "TFID oswa DH7", 
                "placeholder-password": "Modpas", 
                connect: "KONEKTE", 
                register: "KREYE YON KONT", 
                "placeholder-lastname": "Nom", 
                "placeholder-firstname": "Prenom", 
                "placeholder-dh7": "DH7 ID (@dh7.tf)", 
                "placeholder-age": "Laj", 
                "create-account": "JOIN D'H7", 
                "back-to-login": "RETOUNEN", 
                "logout-btn": "DEKONEKTE", 
                chat_placeholder: "Ekris mesaj ou...",
                exceed_msg: "Ou depase limit 2000 karaktè (espas pa konte)"
            },
            fr: { 
                subtitle: "Digital HUB 7", 
                "placeholder-tfid": "TFID ou DH7", 
                "placeholder-password": "Mot de passe", 
                connect: "SE CONNECTER", 
                register: "CRÉER UN COMPTE", 
                "placeholder-lastname": "Nom", 
                "placeholder-firstname": "Prénom", 
                "placeholder-dh7": "DH7 ID (@dh7.tf)", 
                "placeholder-age": "Âge", 
                "create-account": "REJOINDRE D'H7", 
                "back-to-login": "RETOUR", 
                "logout-btn": "DÉCONNEXION", 
                chat_placeholder: "Tapez votre message...",
                exceed_msg: "Vous avez dépassé la limite de 2000 caractères (espaces non comptés)"
            },
            en: { 
                subtitle: "Digital HUB 7", 
                "placeholder-tfid": "TFID or DH7", 
                "placeholder-password": "Password", 
                connect: "LOGIN", 
                register: "CREATE ACCOUNT", 
                "placeholder-lastname": "Last Name", 
                "placeholder-firstname": "First Name", 
                "placeholder-dh7": "DH7 ID (@dh7.tf)", 
                "placeholder-age": "Age", 
                "create-account": "JOIN D'H7", 
                "back-to-login": "BACK", 
                "logout-btn": "LOGOUT", 
                chat_placeholder: "Type your message...",
                exceed_msg: "You exceeded the 2000 character limit (spaces not counted)"
            },
            es: { 
                subtitle: "Digital HUB 7", 
                "placeholder-tfid": "TFID o DH7", 
                "placeholder-password": "Contraseña", 
                connect: "CONECTAR", 
                register: "CREAR CUENTA", 
                "placeholder-lastname": "Apellido", 
                "placeholder-firstname": "Nombre", 
                "placeholder-dh7": "DH7 ID (@dh7.tf)", 
                "placeholder-age": "Edad", 
                "create-account": "UNIRSE A D'H7", 
                "back-to-login": "REGRESAR", 
                "logout-btn": "CERRAR SESIÓN", 
                chat_placeholder: "Escribe tu mensaje...",
                exceed_msg: "Has excedido el límite de 2000 caracteres (espacios no cuentan)"
            }
        };

        let currentMedia = null;
        let recorder = null;
        let audioChunks = [];
        let recording = false;
        let messageCount = 0;
        let isWaiting = false;
        let currentTypingEl = null;

        async function login() {
            let id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value;
            if (!id || !pass) return alert("Ranpli tout chan yo");
            if (!id.includes('@dh7.tf') && !id.startsWith('TF-')) id += '@dh7.tf';

            try {
                const res = await fetch(`${API_AUTH}/login`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ identifier: id, password: pass }) 
                });
                const data = await res.json();
                if (data.success) {
                    currentUser = data.user;
                    currentTfid = data.user.tfid;
                    localStorage.setItem(SESSION_KEY, JSON.stringify(currentUser));
                    showChat();
                } else {
                    alert(data.error || "Erreur connexion");
                }
            } catch (e) {
                alert("Pa ka kontakte sèvè a");
            }
        }

        async function register() {
            const nom = document.getElementById('reg-nom').value.trim();
            const prenom = document.getElementById('reg-prenom').value.trim();
            let dh7 = document.getElementById('reg-dh7').value.trim();
            const age = parseInt(document.getElementById('reg-age').value);
            const pass = document.getElementById('reg-pass').value;

            if (!nom || !prenom || !dh7 || isNaN(age) || !pass) return alert("Tout chan obligatwa");
            if (!dh7.includes('@dh7.tf')) dh7 += '@dh7.tf';

            try {
                const res = await fetch(`${API_AUTH}/register`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ nom, prenom, dh7, age, password: pass }) 
                });
                const result = await res.json();
                if (result.success) {
                    alert(`Kont kreye! TFID ou: ${result.tfid}`);
                    toggleAuth();
                } else {
                    alert(result.error || "Erreur");
                }
            } catch (e) {
                alert("Erreur sèvè");
            }
        }

        function toggleAuth() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('reg-form').classList.toggle('hidden');
        }

        function logout() {
            localStorage.removeItem(SESSION_KEY);
            location.reload();
        }

        function showChat() {
            document.getElementById('scr-auth').classList.add('hidden');
            document.getElementById('scr-chat').classList.add('visible');

            const name = `${currentUser.prenom || ''} ${currentUser.nom || ''}`.trim();
            document.getElementById('user-name').textContent = name || 'Itilizatè';
            document.getElementById('user-tfid').textContent = currentUser.tfid || '';
            if (currentUser.dh7) {
                document.getElementById('user-dh7').textContent = currentUser.dh7;
                document.getElementById('user-dh7-line').classList.remove('hidden');
            }

            changeLanguage(currentLanguage);
            initChat();
        }

        async function initChat() {
            chatBox.innerHTML = '';
            messageCount = 0;
            await loadOrUpdateSession();
        }

        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const actionBtn = document.getElementById('actionBtn');
        const attachBtn = document.getElementById('attachBtn');
        const fileInput = document.getElementById('fileInput');
        const previewContainer = document.getElementById('previewContainer');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        function updateActionIcon() {
            const hasText = userInput.value.trim().length > 0;
            const hasMedia = currentMedia !== null;
            if (recording) {
                actionBtn.innerHTML = `<svg viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" fill="white"/></svg>`;
            } else if (!hasText && !hasMedia) {
                actionBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.47,17.5 13,17.96V21H11V17.96C7.53,17.5 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z" fill="white"/></svg>`;
            } else {
                actionBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" fill="white"/></svg>`;
            }
            actionBtn.disabled = !(hasText || hasMedia || recording);
        }

        function clearPreview() {
            previewContainer.innerHTML = '';
            if (currentMedia && currentMedia.previewURL) {
                URL.revokeObjectURL(currentMedia.previewURL);
            }
            currentMedia = null;
        }

        function addPreview(type, previewURL, base64Data) {
            clearPreview();
            const item = document.createElement('div');
            item.className = 'preview-item';

            const mediaEl = document.createElement(type === 'audio' ? 'audio' : type === 'video' ? 'video' : 'img');
            mediaEl.src = previewURL;
            mediaEl.controls = type !== 'img';
            mediaEl.style.borderRadius = '14px';
            item.appendChild(mediaEl);

            const removeBtn = document.createElement('div');
            removeBtn.className = 'preview-remove';
            removeBtn.textContent = '✖';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                clearPreview();
                updateActionIcon();
            };
            item.appendChild(removeBtn);

            mediaEl.onclick = () => openModal(previewURL, type);

            previewContainer.appendChild(item);

            currentMedia = { type: type === 'img' ? 'image' : 'audio', data: base64Data, previewURL };
            updateActionIcon();
        }

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                recorder = new MediaRecorder(stream);
                audioChunks = [];
                recorder.ondataavailable = e => audioChunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const previewURL = URL.createObjectURL(blob);
                    const reader = new FileReader();
                    reader.onload = () => addPreview('audio', previewURL, reader.result.split(',')[1]);
                    reader.readAsDataURL(blob);
                    stream.getTracks().forEach(track => track.stop());
                };
                recorder.start();
                recording = true;
                updateActionIcon();
            }).catch(() => alert('Mikwo pa aksesib'));
        }

        function stopRecording() {
            if (recorder && recording) {
                recorder.stop();
                recording = false;
                updateActionIcon();
            }
        }

        attachBtn.onclick = () => fileInput.click();

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const isImage = file.type.startsWith('image/');
            const isVideo = file.type.startsWith('video/');
            const isAudio = file.type.startsWith('audio/');
            if (!isImage && !isVideo && !isAudio) return alert('Fichye sa pa sipòte');

            const previewURL = URL.createObjectURL(file);
            const reader = new FileReader();
            reader.onload = () => {
                const type = isImage ? 'img' : isVideo ? 'video' : 'audio';
                addPreview(type, previewURL, reader.result.split(',')[1]);
            };
            reader.readAsDataURL(file);
        };

        actionBtn.onclick = () => {
            if (recording) {
                stopRecording();
            } else if (userInput.value.trim() === '' && currentMedia === null) {
                startRecording();
            } else {
                sendMessage();
            }
        };

        async function sendMessage() {
            if (isWaiting) return;

            const text = userInput.value.trim();
            const charCount = text.replace(/\s/g, '').length;
            if (text && charCount > 2000) {
                showError(translations[currentLanguage].exceed_msg);
                return;
            }

            isWaiting = true;
            actionBtn.disabled = true;

            if (text) renderMessage({who: 'user', text});
            if (currentMedia) {
                renderMessage({who: 'user', mediaType: currentMedia.type === 'image' ? 'img' : 'video', mediaSrc: currentMedia.previewURL});
            }

            userInput.value = '';
            clearPreview();
            updateActionIcon();
            showTyping();

            const body = { tfid: currentTfid };
            if (text) body.text = text;
            if (currentMedia) {
                if (currentMedia.type === 'image') body.image = currentMedia.data;
                else body.audio = currentMedia.data;
            }

            try {
                const res = await fetch(API_WORKER, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                hideTyping();
                await loadOrUpdateSession();
            } catch (e) {
                hideTyping();
                showError('Erreur envoi');
            } finally {
                isWaiting = false;
                updateActionIcon();
            }
        }

        function renderMessage({who='bot', text=null, mediaType=null, mediaSrc=null, audioBase64=null, images=null, ts=Date.now()}) {
            const msg = document.createElement('div');
            msg.className = `message ${who}`;

            if (text) {
                const bubble = document.createElement('div');
                bubble.className = `bubble ${who}`;
                if (who === 'bot') bubble.appendChild(formatToFragment(text));
                else bubble.textContent = text;
                msg.appendChild(bubble);
            }

            if (mediaType || audioBase64 || images) {
                const mediaDiv = document.createElement('div');
                mediaDiv.className = 'message-media';

                if (audioBase64) {
                    const audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = `data:audio/mpeg;base64,${audioBase64}`;
                    if (who === 'bot') audio.autoplay = true;
                    mediaDiv.appendChild(audio);
                } else if (mediaType) {
                    const el = document.createElement(mediaType === 'img' ? 'img' : 'video');
                    el.src = mediaSrc;
                    el.controls = mediaType !== 'img';
                    el.onclick = () => openModal(mediaSrc, mediaType === 'img' ? 'image' : 'video');
                    mediaDiv.appendChild(el);
                } else if (images) {
                    images.forEach(src => {
                        const img = document.createElement('img');
                        img.src = src;
                        img.onclick = () => openModal(src, 'image');
                        mediaDiv.appendChild(img);
                    });
                }
                msg.appendChild(mediaDiv);
            }

            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            msg.appendChild(meta);

            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function formatToFragment(raw) {
            if (!raw) return document.createDocumentFragment();
            let s = String(raw).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
            const codeBlocks = [];
            s = s.replace(/```([\s\S]*?)```/g, (m, inner) => { codeBlocks.push(inner); return `@@CODEBLOCK_${codeBlocks.length-1}@@`; });
            const frag = document.createDocumentFragment();
            const paragraphs = s.split(/\n{2,}/g);
            paragraphs.forEach(par => {
                if (/^@@CODEBLOCK_\d+@@$/.test(par)) {
                    const idx = parseInt(par.match(/\d+/)[0]);
                    const pre = document.createElement('pre');
                    pre.className = 'wa-code-block copied-flash';
                    pre.textContent = codeBlocks[idx] || '';
                    pre.setAttribute('data-plain', codeBlocks[idx] || '');
                    frag.appendChild(pre);
                    return;
                }
                const container = document.createDocumentFragment();
                let cursor = 0;
                const tokenRe = /(@@CODEBLOCK_(\d+)@@)/g;
                let m;
                while ((m = tokenRe.exec(par)) !== null) {
                    if (m.index > cursor) container.appendChild(buildParagraphs(par.slice(cursor, m.index)));
                    const pre = document.createElement('pre');
                    pre.className = 'wa-code-block copied-flash';
                    const idx = parseInt(m[2]);
                    pre.textContent = codeBlocks[idx] || '';
                    pre.setAttribute('data-plain', codeBlocks[idx] || '');
                    container.appendChild(pre);
                    cursor = tokenRe.lastIndex;
                }
                if (cursor < par.length) container.appendChild(buildParagraphs(par.slice(cursor)));
                frag.appendChild(container);
            });
            return frag;
        }

        function buildParagraphs(text) {
            const frag = document.createDocumentFragment();
            const lines = text.split('\n');
            lines.forEach(line => {
                const div = document.createElement('div');
                div.className = 'wa-paragraph';
                const bullet = line.match(/^(\s*)[-*•]\s+(.*)/);
                if (bullet) {
                    const b = document.createElement('span');
                    b.className = 'wa-bullet';
                    b.textContent = '•';
                    div.appendChild(b);
                    line = bullet[2];
                }
                const temp = document.createElement('div');
                temp.innerHTML = line
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="wa-strong">$1</strong>')
                    .replace(/__(.*?)__/g, '<strong class="wa-strong">$1</strong>')
                    .replace(/~~(.*?)~~/g, '<del>$1</del>')
                    .replace(/~(.*?)~/g, '<span class="wa-underline">$1</span>')
                    .replace(/`(.*?)`/g, '<span class="wa-inline copied-flash" data-plain="$1">$1</span>');
                while (temp.firstChild) div.appendChild(temp.firstChild);
                frag.appendChild(div);
            });
            return frag;
        }

        function showTyping() {
            if (currentTypingEl) currentTypingEl.remove();
            const msg = document.createElement('div');
            msg.className = 'message bot';
            const bubble = document.createElement('div');
            bubble.className = 'bubble bot';
            const dots = document.createElement('span');
            dots.textContent = '•••';
            dots.style.animation = 'dots 1.4s infinite';
            bubble.appendChild(dots);
            msg.appendChild(bubble);
            chatBox.appendChild(msg);
            chatBox.scrollTop = chatBox.scrollHeight;
            currentTypingEl = msg;
        }

        function hideTyping() {
            if (currentTypingEl) {
                currentTypingEl.remove();
                currentTypingEl = null;
            }
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 4000);
        }

        async function fetchSession() {
            if (!currentTfid) return null;
            try {
                const res = await fetch(`${API_WORKER}?tfid=${currentTfid}`);
                if (!res.ok) return null;
                const j = await res.json();
                if (j.ok && j.session?.messages) return j.session.messages;
            } catch {}
            return null;
        }

        async function loadOrUpdateSession() {
            const messages = await fetchSession();
            if (!messages || messages.length === 0) return;

            const newMsgs = messages.slice(messageCount);
            if (newMsgs.length === 0) return;

            hideTyping();

            newMsgs.forEach(m => {
                const who = m.from === 'user' ? 'user' : 'bot';
                renderMessage({
                    who,
                    text: m.text || null,
                    mediaType: m.type === 'image' ? 'img' : null,
                    mediaSrc: m.type === 'image' ? m.url : null,
                    audioBase64: m.audio || null,
                    ts: m.ts || Date.now()
                });
            });

            messageCount = messages.length;
        }

        function openModal(src, type) {
            modalContent.innerHTML = '';
            const el = document.createElement(type === 'image' ? 'img' : type === 'video' ? 'video' : 'audio');
            el.src = src;
            if (type !== 'image') el.controls = true;
            modalContent.appendChild(el);
            downloadBtn.style.display = type === 'image' ? 'block' : 'none';
            downloadBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = src;
                a.download = type === 'image' ? 'image.png' : 'media';
                a.click();
            };
            modal.classList.add('active');
        }

        closeModalBtn.onclick = () => modal.classList.remove('active');
        modal.onclick = (e) => e.target === modal && modal.classList.remove('active');

        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 180) + 'px';
            updateActionIcon();
        });

        userInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (userInput.value.trim() || currentMedia) sendMessage();
            }
        });

        document.getElementById('menuBtn').addEventListener('click', toggleMenu);

        function toggleMenu() {
            document.getElementById('userMenu').classList.toggle('show');
            document.getElementById('menuBackdrop').classList.toggle('show');
        }

        function closeMenu() {
            document.getElementById('userMenu').classList.remove('show');
            document.getElementById('menuBackdrop').classList.remove('show');
        }

        function showLang() {
            document.getElementById('backdrop').classList.add('show');
            document.getElementById('lang-sheet').classList.add('show');
        }

        function closeOverlays() {
            document.getElementById('backdrop').classList.remove('show');
            document.getElementById('lang-sheet').classList.remove('show');
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            const t = translations[lang];

            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.dataset.key;
                if (t[key]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = t[key];
                    else el.innerText = t[key];
                }
            });

            document.getElementById('userInput').placeholder = t.chat_placeholder;
        }

        document.addEventListener('click', e => {
            const el = e.target.closest('[data-plain]');
            if (el) {
                const txt = el.getAttribute('data-plain') || el.textContent;
                navigator.clipboard?.writeText(txt).then(() => {
                    el.classList.add('copied');
                    setTimeout(() => el.classList.remove('copied'), 1000);
                });
            }
        });

        (function init() {
            currentUser = JSON.parse(localStorage.getItem(SESSION_KEY));
            if (currentUser && currentUser.tfid) {
                currentTfid = currentUser.tfid;
                showChat();
            } else {
                changeLanguage(currentLanguage);
            }
            updateActionIcon();
        })();
    </script>
</body>
</html>
