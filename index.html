<!DOCTYPE html>
<html lang="ht">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare AI Lab - V√®syon Korije</title>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 800px; margin: auto; padding: 20px; background: #f0f2f5; color: #333; }
        h1 { text-align: center; color: #f38020; }
        .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
        h3 { margin-top: 0; color: #f38020; }
        button { background: #f38020; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 8px 4px; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        button.stop { background: #d32f2f; }
        button.upload { background: #1976d2; }
        pre { background: #1e1e1e; color: #0f0; padding: 16px; border-radius: 8px; overflow-x: auto; min-height: 80px; margin-top: 16px; white-space: pre-wrap; }
        .record-controls { margin: 16px 0; }
        #timer { font-size: 1.5em; font-weight: bold; color: #f38020; }
        #recordStatus { margin: 8px 0; }
        audio { margin-top: 10px; width: 100%; }
        .or { text-align: center; margin: 20px 0; font-weight: bold; color: #666; }
    </style>
</head>
<body>

    <h1>üî• AI Dashboard V√®syon Korije</h1>

    <div class="card">
        <h3>üì∑ Analize Imaj</h3>
        <input type="file" id="imgInput" accept="image/*">
        <button id="btnImg">Analize Imaj</button>
        <pre id="resImg">Atann rezilta...</pre>
    </div>

    <div class="card">
        <h3>üéôÔ∏è Transkri Vwa (Audio to Text)</h3>
        
        <div class="record-controls">
            <p id="recordStatus">Prepare pou enregistre... (asire w bay p√®misyon mikwof√≤n)</p>
            <p id="timer">00:00</p>
            <button id="startBtn">üü¢ K√≤manse Enregistre</button>
            <button id="stopBtn" class="stop" disabled>üî¥ Sispann</button>
            <audio id="previewAudio" controls style="display:none;"></audio>
        </div>

        <div class="or">‚Äî‚Äî OSWA ‚Äî‚Äî</div>

        <div>
            <input type="file" id="audioFile" accept="audio/*,video/*">
            <button id="uploadBtn" class="upload">Voye Fichye Audio</button>
        </div>

        <pre id="resAudio">Atann rezilta...</pre>
    </div>

    <script>
        const BASE_URL = "https://teste.adamdh7.org"; // Chanje si bezwen

        let mediaRecorder;
        let audioChunks = [];
        let timerInterval;
        let seconds = 0;
        let recordedBlob = null;

        function formatTime(sec) {
            const m = String(Math.floor(sec / 60)).padStart(2, '0');
            const s = String(sec % 60).padStart(2, '0');
            return `${m}:${s}`;
        }

        // Fonksyon pou jwenn yon mimeType ki sip√≤te
        function getSupportedMimeType() {
            const types = [
                'audio/webm;codecs=opus',
                'audio/webm',
                'audio/mp4',
                'audio/ogg',
                'audio/wav'
            ];
            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) {
                    return type;
                }
            }
            return ''; // Si okenn, kite navigat√® a chwazi
        }

        document.getElementById('startBtn').onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioChunks = [];

                const mimeType = getSupportedMimeType();
                const options = mimeType ? { mimeType } : {};

                mediaRecorder = new MediaRecorder(stream, options);

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                mediaRecorder.onstop = () => {
                    const finalMime = mediaRecorder.mimeType || mimeType || 'audio/webm';
                    recordedBlob = new Blob(audioChunks, { type: finalMime });
                    const preview = document.getElementById('previewAudio');
                    preview.src = URL.createObjectURL(recordedBlob);
                    preview.style.display = 'block';

                    // Voye otomatikman
                    processAudio(recordedBlob, 'resAudio');
                    
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordStatus').innerText = "Y ap enregistre... Pale byen kl√®!";

                seconds = 0;
                document.getElementById('timer').innerText = formatTime(0);
                timerInterval = setInterval(() => {
                    seconds++;
                    document.getElementById('timer').innerText = formatTime(seconds);
                }, 1000);

            } catch (err) {
                alert("Pwobl√®m ak mikwof√≤n: " + err.message + "\nTcheke p√®misyon ak eseye ank√≤.");
            }
        };

        document.getElementById('stopBtn').onclick = () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(timerInterval);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('recordStatus').innerText = "Enregistrman fini ‚Äì y ap voye pou transkri...";
            }
        };

        document.getElementById('uploadBtn').onclick = () => {
            const fileInput = document.getElementById('audioFile');
            if (!fileInput.files[0]) return alert("Chwazi yon fichye audio anvan!");
            processAudio(fileInput.files[0], 'resAudio');
        };

        document.getElementById('btnImg').onclick = () => {
            const fileInput = document.getElementById('imgInput');
            if (!fileInput.files[0]) return alert("Chwazi yon imaj anvan!");
            processImage(fileInput.files[0]);
        };

        async function processAudio(blobOrFile, resId) {
            const resBox = document.getElementById(resId);
            resBox.innerText = "Y ap trete audio a... (sa ka pran k√®k segonn)";
            
            try {
                const response = await fetch(`${BASE_URL}/audio-to-text`, { method: 'POST', body: blobOrFile });
                
                let data = {};
                if (response.headers.get("Content-Type")?.includes("application/json")) {
                    try { data = await response.json(); } catch {}
                }

                if (!response.ok) {
                    throw new Error(data.error || `Er√® s√®v√®: ${response.status} (pa gen detay)`);
                }

                resBox.innerText = data.text || JSON.stringify(data, null, 2);
            } catch (err) {
                resBox.innerText = "Er√®: " + err.message;
                console.error(err);
            }
        }

        async function processImage(file) {
            const resBox = document.getElementById('resImg');
            resBox.innerText = "Y ap analize imaj la...";
            
            try {
                const response = await fetch(`${BASE_URL}/analize-imaj`, { method: 'POST', body: file });
                
                let data = {};
                if (response.headers.get("Content-Type")?.includes("application/json")) {
                    try { data = await response.json(); } catch {}
                }

                if (!response.ok) {
                    throw new Error(data.error || `Er√® s√®v√®: ${response.status} (pa gen detay)`);
                }

                const text = data.response || data.description || data.text || JSON.stringify(data, null, 2);
                resBox.innerText = text;
            } catch (err) {
                resBox.innerText = "Er√®: " + err.message;
                console.error(err);
            }
        }
    </script>
</body>
</html>
